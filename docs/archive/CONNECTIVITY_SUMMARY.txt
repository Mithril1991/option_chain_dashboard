================================================================================
OPTION CHAIN DASHBOARD - CONNECTIVITY ISSUES ANALYSIS
================================================================================

Date: 2026-01-27
Status: CRITICAL - Backend API not running, frontend isolated
Analysis: COMPLETE

================================================================================
THE PROBLEM (What Users See)
================================================================================

When accessing the dashboard at http://192.168.1.16:8060, users report:

1. "Health Check Error" - Can't verify API is alive
2. "Failed to load alerts" - Alerts API unreachable
3. "Error loading option chain" - Options API unreachable
4. "Trigger new scan does nothing" - Scan API unreachable
5. Configuration page is read-only - Can't toggle demo/prod mode

================================================================================
ROOT CAUSES (Why It Happens)
================================================================================

CRITICAL ISSUE #1: Backend API Not Running
- Port 8061 is NOT listening
- Last log shows API shutdown at 2026-01-27T12:24:16
- DuckDB database is locked by another process (PID 563181)
- API can't start because database is locked
- IMPACT: No backend = no data for frontend to display

CRITICAL ISSUE #2: Hardcoded Localhost URLs
- Frontend configured to call: http://localhost:8061
- localhost only resolves on the same machine
- When accessing from 192.168.1.16, browser tries to reach 192.168.1.16:8061 localhost
- But requests actually go to browser's localhost, not server's localhost
- IMPACT: Requests go to wrong address, API unreachable

CRITICAL ISSUE #3: CORS Blocks Remote Access
- API CORS config only allows:
  * http://localhost:8060
  * http://127.0.0.1:8060
- When browser at 192.168.1.16:8060 makes request, CORS policy blocks it
- IMPACT: Even if API were running, requests from different IP would be blocked

MEDIUM ISSUE #4: WebSocket Hardcoded
- WebSocket URL hardcoded as ws://localhost:8061/ws
- Same problem as HTTP URLs - won't work from different IP
- IMPACT: Real-time updates don't work from network access

MEDIUM ISSUE #5: Demo Mode Hardcoded
- config.yaml has demo_mode: true
- No API endpoint to toggle this
- Configuration page is read-only
- IMPACT: Users can't switch between demo and production data

================================================================================
WHAT'S WORKING
================================================================================

✓ Frontend Vite dev server on port 8060 - RUNNING
✓ All API endpoints properly implemented - VERIFIED IN LOGS
✓ Error handling in frontend - WORKING
✓ Request/response middleware - WORKING
✓ Database schema and initialization - WORKING (when not locked)
✓ Configuration loading - WORKING
✓ Logging - WORKING

Examples of successful API requests from logs (when API was running):
  - GET /health → 200 OK
  - GET /alerts/latest → 200 OK
  - GET /options/AAPL/snapshot → 200 OK
  - GET /features/TSLA/latest → 200 OK
  - GET /config/data-mode → 200 OK

================================================================================
FILES INVOLVED
================================================================================

BACKEND (Python/FastAPI):
  /mnt/shared_ubuntu/Claude/Projects/option_chain_dashboard/scripts/run_api.py
    - Lines 493-499: CORS configuration (needs update)
    - Lines 1507-1513: Server binding (correct)

FRONTEND (React/TypeScript):
  /mnt/shared_ubuntu/Claude/Projects/option_chain_dashboard/frontend/.env
    - VITE_API_BASE_URL=http://localhost:8061 (needs update)

  /mnt/shared_ubuntu/Claude/Projects/option_chain_dashboard/frontend/src/utils/apiClient.ts
    - Line 3: Falls back to localhost:8061 (needs fixing)

  /mnt/shared_ubuntu/Claude/Projects/option_chain_dashboard/frontend/src/utils/constants.ts
    - Line 10: WEBSOCKET hardcoded (needs fixing)

DATABASE:
  /mnt/shared_ubuntu/Claude/Projects/option_chain_dashboard/data/cache.db
    - Currently locked by process PID 563181
    - Must be released before API can start

CONFIG:
  /mnt/shared_ubuntu/Claude/Projects/option_chain_dashboard/config.yaml
    - demo_mode: true (can't toggle in UI)

================================================================================
THE FIX (What To Do)
================================================================================

PHASE 1 - EMERGENCY (Get API running) - 30 minutes
────────────────────────────────────────────────

1. Kill DuckDB lock holder:
   ps aux | grep python | grep -v grep
   kill -9 563181  # or whatever PID is holding lock

2. Start API server:
   cd /mnt/shared_ubuntu/Claude/Projects/option_chain_dashboard
   python scripts/run_api.py

3. Verify it's running:
   curl http://localhost:8061/health
   # Should return: {"status":"ok","timestamp":"..."}

STATUS AFTER PHASE 1: Dashboard will work from localhost:8060 but not from network


PHASE 2 - NETWORK ACCESS (Fix hostname/CORS) - 1 hour
──────────────────────────────────────────────────────

1. Update API CORS configuration:
   File: /mnt/shared_ubuntu/Claude/Projects/option_chain_dashboard/scripts/run_api.py
   Change lines 493-499 from:
     allow_origins=["http://localhost:8060", "127.0.0.1:8060"],
   To:
     allow_origins=["*"],  # For development

   OR (recommended for production):
     import os
     ALLOWED_ORIGINS = os.getenv(
         "ALLOWED_ORIGINS",
         "http://localhost:8060,http://127.0.0.1:8060,http://192.168.1.16:8060"
     ).split(",")
     allow_origins=ALLOWED_ORIGINS,

2. Update frontend API URL:
   File: /mnt/shared_ubuntu/Claude/Projects/option_chain_dashboard/frontend/.env
   Change:
     VITE_API_BASE_URL=http://localhost:8061
   To:
     VITE_API_BASE_URL=http://192.168.1.16:8061

3. Update WebSocket URL (optional but recommended):
   File: /mnt/shared_ubuntu/Claude/Projects/option_chain_dashboard/frontend/src/utils/constants.ts
   Change line 10 from:
     WEBSOCKET: 'ws://localhost:8061/ws'
   To dynamic:
     WEBSOCKET: (function() {
       const base = import.meta.env.VITE_API_BASE_URL || window.location.origin
       return base.replace(/^https?:/, (m) => m === 'https:' ? 'wss:' : 'ws:').concat('/ws')
     })()

STATUS AFTER PHASE 2: Dashboard will work from any network IP


PHASE 3 - FEATURES (Optional - Config toggle) - 30 minutes
──────────────────────────────────────────────────────────

1. Add POST endpoint to toggle demo mode
2. Add frontend hook to call it
3. Update ConfigStatus page with toggle buttons

STATUS AFTER PHASE 3: Users can switch demo/production modes


PHASE 4 - TESTING
──────────────────

Test from different machine:
1. curl http://192.168.1.16:8061/health → 200 OK
2. curl http://192.168.1.16:8061/alerts/latest → alerts returned
3. curl http://192.168.1.16:8061/options/AAPL/snapshot → chain data returned
4. Browser to http://192.168.1.16:8060 → Dashboard loads, no errors
5. Health check passes (no red error box)
6. Alerts display properly
7. Option chains load
8. Scan trigger works

================================================================================
IMPLEMENTATION GUIDE
================================================================================

For detailed step-by-step instructions with code examples, see:
  /mnt/shared_ubuntu/Claude/Projects/option_chain_dashboard/CONNECTIVITY_FIX_CHECKLIST.md

For technical deep-dive and root cause analysis, see:
  /mnt/shared_ubuntu/Claude/Projects/option_chain_dashboard/CONNECTIVITY_ANALYSIS.md

================================================================================
QUICK START
================================================================================

1. Emergency mode (API only):
   kill -9 563181
   cd /mnt/shared_ubuntu/Claude/Projects/option_chain_dashboard
   python scripts/run_api.py
   # Test: curl http://localhost:8061/health

2. Network access mode:
   # Edit scripts/run_api.py line 495:
   allow_origins=["*"]

   # Edit frontend/.env:
   VITE_API_BASE_URL=http://192.168.1.16:8061

   # Restart both servers

3. Full production:
   # Use ALLOWED_ORIGINS environment variable
   # Make all URLs dynamic
   # See CONNECTIVITY_FIX_CHECKLIST.md for complete guide

================================================================================
TESTING COMMANDS
================================================================================

From command line:
  curl http://localhost:8061/health
  curl http://192.168.1.16:8061/health
  curl "http://192.168.1.16:8061/alerts/latest?limit=5"
  curl "http://192.168.1.16:8061/options/AAPL/snapshot"
  curl -X POST "http://192.168.1.16:8061/scan/run"

From browser:
  http://localhost:8060 (localhost only)
  http://192.168.1.16:8060 (network access)

Check Network tab in browser DevTools:
  All API calls should go to 192.168.1.16:8061
  No CORS errors
  Status 200 OK for all endpoints

================================================================================
TIMELINE
================================================================================

Phase 1 (Emergency):           30 minutes
Phase 2 (Network Access):      60 minutes
Phase 3 (Configuration):       30 minutes
Phase 4 (Testing):             30 minutes
────────────────────────────────────────
TOTAL ESTIMATE:                2.5 hours

Quick fix (localhost only):     10 minutes
Quick fix (basic network):      45 minutes

================================================================================
SUCCESS CRITERIA
================================================================================

After implementing all fixes:

□ Dashboard accessible from http://192.168.1.16:8060
□ No "Health Check Error" error message on dashboard
□ Recent Alerts section loads and displays alerts
□ Option chains can be viewed
□ Scan trigger button works (no silent failures)
□ Configuration page editable (can toggle modes)
□ Browser console has no errors or warnings
□ Network tab shows requests to correct IP (192.168.1.16)
□ All API endpoints return valid data
□ Works on any machine on the network

================================================================================
RELATED ISSUES & TASKS
================================================================================

Task #1: Fix network accessibility - bind to 0.0.0.0:8060 for React frontend
  Status: COMPLETED ✓
  Evidence: Port 8060 listens on 0.0.0.0

Task #2: Fix network accessibility - bind to 0.0.0.0:8061 for FastAPI backend
  Status: IN PROGRESS (code correct, service not running)
  Next: Start the service after fixing database lock

Task #3: Resolve DuckDB concurrency between scheduler and API
  Status: BLOCKING (must fix before API can start)
  Issue: Database locked by PID 563181
  Action: Kill the lock-holding process

Task #7: Fix dashboard Health Check Error - backend API connectivity
  Status: DEPENDS ON (Task #2, #3)
  Fix: Start API after releasing database lock

Task #10: Fix Failed to load alerts and Option chain errors
  Status: DEPENDS ON (Task #2, #3, Phase 2)
  Fix: Start API + update CORS + update frontend URLs

Task #8: Make Configuration page editable in dashboard
  Status: BLOCKED (depends on Phase 3)
  Fix: Add POST endpoint + frontend form

Task #9: Add demo/prod mode toggle in dashboard
  Status: BLOCKED (depends on Phase 3)
  Fix: Implement demo mode toggle endpoint

================================================================================
TECHNICAL NOTES
================================================================================

Why localhost fails over network:
  - Browser and server each have their own localhost definition
  - localhost = 127.0.0.1 on the machine running it
  - When browser on 192.168.1.16 reaches localhost, it's its own 127.0.0.1
  - API is at 192.168.1.16, not 127.0.0.1 on the client
  - Solution: Use actual IP address instead of localhost

CORS details:
  - Origin header = protocol + host + port
  - http://192.168.1.16:8060 is different from http://localhost:8060
  - Server must explicitly allow it in CORS headers
  - Browsers enforce this for security (prevent cross-site attacks)
  - Solution: Add IP to allow_origins list

Why API responses work in logs:
  - Logs show requests from curl and browser on same machine
  - Those requests used localhost:8060 → localhost:8061
  - Works because both on same machine
  - Fails when client on different IP tries to reach different IP

================================================================================
NEXT STEPS
================================================================================

1. READ: CONNECTIVITY_ANALYSIS.md (technical deep dive)
2. READ: CONNECTIVITY_FIX_CHECKLIST.md (implementation guide)
3. EXECUTE: Phase 1 (Emergency - 30 min)
4. TEST: Verify API working with curl
5. EXECUTE: Phase 2 (Network - 1 hour)
6. TEST: Verify from different machine
7. EXECUTE: Phase 3 (Features - 30 min if needed)
8. EXECUTE: Phase 4 (Full testing)

Estimated total time: 2.5 hours to full working state

================================================================================
SUMMARY
================================================================================

Problem: Dashboard can't reach API, shows connectivity errors
Root causes: API not running, hardcoded localhost URLs, CORS blocking remote access
Status: All components properly implemented, just need configuration updates
Effort: 2.5 hours to complete all phases
Priority: CRITICAL - blocks all functionality

The fix is straightforward:
1. Kill database lock holder
2. Start API server
3. Update CORS configuration
4. Update frontend API base URL
5. Test from network

Full details in: CONNECTIVITY_FIX_CHECKLIST.md
Technical analysis: CONNECTIVITY_ANALYSIS.md

================================================================================
